---
- name: Ensure that deploy owns /srv/www and /srv/www/shared
  file:
    state: directory
    owner: deploy
    group: deploy
    path: "{{item}}"
  with_items:
    - /srv/www/production
    - /srv/www/production/shared

# TODO: Extract variable
- name: Set the ruby version for the alaveteli deploy
  copy:
    content: 2.0.0-p598
    dest: /srv/www/production/shared/rbenv-version

# Installing via bash so that rbenv is used. Otherwise would install gems for default system ruby
# TODO When gem is already installed stop it from saying something has changed
- name: Install bundler gem
  command: bash -lc "gem install bundler"
  become: true
  become_user: deploy

# - name: Add mySociety Debian Package Repository key
#   apt_key: url="https://debian.mysociety.org/debian.mysociety.org.gpg.key"
#
# - name: Add mySociety Debian Package Repository
#   apt_repository: repo="deb http://debian.mysociety.org squeeze main"

- name: Add postgresql apt repository
  apt_repository:
    repo: deb http://apt.postgresql.org/pub/repos/apt/ xenial-pgdg main
    filename: pgdg

- name: Import postgresql repository signing key
  apt_key:
    url: https://www.postgresql.org/media/keys/ACCC4CF8.asc
    id: ACCC4CF8

# We're using a slightly older postgres client so that pg_dump still
# works with "-i" which would cause a rails migration to fail otherwise.
# This will be fixed by upgrading to the latest alavetelli.
# TODO: Not sure if postgresql-client-9.5 gets installed somewhere along the way too
- name: Install postgresql-client-9.4
  apt:
    pkg: "{{ item }}"
    update_cache: true
  with_items:
    - postgresql-client-9.4
    - libpq-dev

- name: Install packages required by Alaveteli
  apt: name={{ item }} state=present
  with_items:
    - libicu-dev
    - libmagic-dev
    - libmagickwand-dev
    - xapian-tools
    - uuid-dev
    # TODO: We need to install wkhtmltopdf
    # - wkhtmltopdf-static
    - pdftk

# For some unknown reason on Ubuntu 16.04 Magick-config isn't in the path
# after installing imagemagick above
- name: Put Magick-config in the path
  file:
    state: link
    src: /usr/lib/x86_64-linux-gnu/ImageMagick-6.8.9/bin-Q16/Magick-config
    dest: /usr/local/bin/Magick-config

- name: Install lockfile-progs for run-with-lockfile.sh
  apt: name=lockfile-progs

# TODO: How do we handle production/staging here?
- name: Link run-with-lockfile.sh so it's available system-wide
  file:
    src: "/srv/www/production/current/commonlib/bin/run-with-lockfile.sh"
    dest: "/usr/bin/run-with-lockfile"
    force: true
    state: link

- name: Install dependency for postgresql_db
  apt: pkg=python-psycopg2

- name: Create database
  postgresql_db:
    login_host: "{{ postgresql_host }}"
    login_user: admin
    login_password: "{{ rds_admin_password }}"
    name: alaveteli

- name: Create posgresql role
  postgresql_user:
    login_host: "{{ postgresql_host }}"
    login_user: admin
    login_password: "{{ rds_admin_password }}"
    db: alaveteli
    name: alaveteli
    password: "{{ db_password }}"
    priv: ALL

- name: Copy over database configuration for application
  template: src=database.yml dest=/srv/www/production/shared/database.yml owner=deploy group=deploy
  notify: nginx restart

- name: Copy init scripts for daemons
  copy:
    dest: /etc/init.d/
    src: "{{ item }}"
    mode: 0755
  with_items:
    - foi-alert-tracks
    - foi-purge-varnish

- name: Generate the overall nginx config
  template: src=nginx.conf dest=/etc/nginx/nginx.conf
  notify: nginx reload

- name: Copy test/test password for staging site
  copy:
    src: htpasswd
    dest: /etc/nginx/
  notify: nginx reload

- name: Copy nginx config for the app
  copy: src=default dest=/etc/nginx/sites-available/ owner=root group=root mode=644
  notify: nginx reload

- name: Copy across the main Alaveteli config
  template: src=general.yml dest=/srv/www/production/shared/ owner=deploy group=deploy
  notify: nginx restart

# Create fake let's encrypt directories when in development
- name: Create fake let's encrypt directories when in development
  file:
    state: directory
    path: "/etc/letsencrypt/live/{{ item }}"
  with_items:
    - "{{ righttoknow_domain }}"
    - "test.{{ righttoknow_domain }}"
  when: "'development' in group_names"

# We need to setup the SSL certificates before we try to configure nginx
# because otherwise nginx will try to look for non-existent certificates
- name: Copy SSL certificates for development
  copy:
    src: "{{ item }}.pem"
    # We're faking it as if these are let's encrypt certs. Makes for less magic config
    dest: "/etc/letsencrypt/live/{{ item }}/fullchain.pem"
    mode: 0644
  with_items:
    - "{{ righttoknow_domain }}"
    - "test.{{ righttoknow_domain }}"
  # Only run this task when this machine is the development group
  when: "'development' in group_names"
  notify: nginx restart

- name: Copy SSL keys for development
  copy:
    src: "{{ item }}.key"
    dest: "/etc/letsencrypt/live/{{ item }}/privkey.pem"
    mode: 0640
  with_items:
    - "{{ righttoknow_domain }}"
    - "test.{{ righttoknow_domain }}"
  # Only run this task when this machine is the development group
  when: "'development' in group_names"
  notify: nginx restart

# TODO: Use let's encrypt to generate production SSL certs

- name: Add alaveteli crontab entry
  cron:
    user: root
    name: "foi-alert-tracks"
    minute: "0,10,20,30,40,50"
    job: "/bin/bash -l -c 'sudo /etc/init.d/foi-alert-tracks check'"
    cron_file: "production"

- name: Add alaveteli crontab entry
  cron:
    user: root
    name: "foi-purge-varnish"
    minute: "0,10,20,30,40,50"
    job: "/bin/bash -l -c 'sudo /etc/init.d/foi-purge-varnish check'"
    cron_file: "production"

- name: Add alaveteli crontab entry
  cron:
    user: deploy
    name: "holidays"
    minute: "0"
    hour: "0"
    day: "1"
    month: "12"
    job: "/bin/bash -l -c '/bin/echo \"A year has passed, please update the bank holidays for the Freedom of Information site, thank you.\"'"
    cron_file: "production"

- name: Add alaveteli crontab entry
  cron:
    user: deploy
    name: "alert-comment-on-request"
    minute: "9"
    job: "/bin/bash -l -c 'cd /srv/www/production/current && RAILS_ENV=production run-with-lockfile -n ./alert-comment-on-request ./script/alert-comment-on-request || echo \"stalled?\"'"
    cron_file: "production"

- name: Add alaveteli crontab entry
  cron:
    user: deploy
    name: "load-mail-server-logs"
    minute: "31"
    job: "/bin/bash -l -c 'cd /srv/www/production/current && RAILS_ENV=production run-with-lockfile -n ./load-mail-server-logs ./script/load-mail-server-logs || echo \"stalled?\"'"
    cron_file: "production"

- name: Add alaveteli crontab entry
  cron:
    user: deploy
    name: "update-xapian-index"
    minute: "0,5,10,15,20,25,30,35,40,45,50,55"
    job: "/bin/bash -l -c 'cd /srv/www/production/current && RAILS_ENV=production run-with-lockfile -n ./update-xapian-index.lock \"./script/update-xapian-index verbose=true\" >> ./log/update-xapian-index.log || echo \"stalled?\"'"
    cron_file: "production"

- name: Add alaveteli crontab entry
  cron:
    user: deploy
    name: "delete-old-things"
    minute: "23"
    hour: "4"
    job: "/bin/bash -l -c 'cd /srv/www/production/current && RAILS_ENV=production run-with-lockfile -n ./delete-old-things ./script/delete-old-things || echo \"stalled?\"'"
    cron_file: "production"

- name: Add alaveteli crontab entry
  cron:
    user: deploy
    name: "alert-overdue-requests"
    minute: "0"
    hour: "6"
    job: "/bin/bash -l -c 'cd /srv/www/production/current && RAILS_ENV=production run-with-lockfile -n ./alert-overdue-requests ./script/alert-overdue-requests || echo \"stalled?\"'"
    cron_file: "production"

- name: Add alaveteli crontab entry
  cron:
    user: deploy
    name: "alert-new-response-reminders"
    minute: "0"
    hour: "7"
    job: "/bin/bash -l -c 'cd /srv/www/production/current && RAILS_ENV=production run-with-lockfile -n ./alert-new-response-reminders ./script/alert-new-response-reminders || echo \"stalled?\"'"
    cron_file: "production"

- name: Add alaveteli crontab entry
  cron:
    user: deploy
    name: "alert-not-clarified-request"
    minute: "0"
    hour: "8"
    job: "/bin/bash -l -c 'cd /srv/www/production/current && RAILS_ENV=production run-with-lockfile -n ./alert-not-clarified-request ./script/alert-not-clarified-request || echo \"stalled?\"'"
    cron_file: "production"

- name: Add alaveteli crontab entry
  cron:
    user: deploy
    name: "check-recent-requests-sent"
    minute: "2"
    hour: "4"
    job: "/bin/bash -l -c 'cd /srv/www/production/current && RAILS_ENV=production run-with-lockfile -n ./check-recent-requests-sent ./script/check-recent-requests-sent || echo \"stalled?\"'"
    cron_file: "production"

- name: Add alaveteli crontab entry
  cron:
    user: deploy
    name: "stop-new-responses-on-old-requests"
    minute: "45"
    hour: "3"
    job: "/bin/bash -l -c 'cd /srv/www/production/current && RAILS_ENV=production run-with-lockfile -n ./stop-new-responses-on-old-requests ./script/stop-new-responses-on-old-requests || echo \"stalled?\"'"
    cron_file: "production"

- name: Add alaveteli crontab entry
  cron:
    user: deploy
    name: "request-creation-graph"
    minute: "43"
    hour: "2"
    job: "/bin/bash -l -c 'cd /srv/www/production/current && RAILS_ENV=production ./script/request-creation-graph'"
    cron_file: "production"

- name: Add alaveteli crontab entry
  cron:
    user: deploy
    name: "user-use-graph"
    minute: "48"
    hour: "2"
    job: "/bin/bash -l -c 'cd /srv/www/production/current && RAILS_ENV=production ./script/user-use-graph'"
    cron_file: "production"

- name: Add deploy user to adm group so it can read mail logs
  user:
    name: deploy
    groups: adm
    append: yes

# TODO: Send output of cron via email to a sensible place

# TODO: Setup alaveteli service in /etc/init.d?

# TODO: Set up incoming email handling including separate email and server address for staging
