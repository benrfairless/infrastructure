---
- name: Install dependency for ansible mysql_db module
  apt:
    pkg: python-mysqldb

# TODO: Do we want a staging setup too?
- name: Create database
  mysql_db:
    login_host: "{{ mysql_host }}"
    login_user: admin
    login_password: "{{ rds_admin_password }}"
    name: "{{ item }}-production"
  with_items:
    - oaf
    - civi

- name: Create civi user with access to the database
  mysql_user:
    login_host: "{{ mysql_host }}"
    login_user: admin
    login_password: "{{ rds_admin_password }}"
    name: civi-production
    password: "{{ civicrm_production_mysql_password }}"
    priv: 'civi-production.*:ALL'
    host: "%"

- name: Create oaf user with access to the database
  mysql_user:
    login_host: "{{ mysql_host }}"
    login_user: admin
    login_password: "{{ rds_admin_password }}"
    name: oaf-production
    password: "{{ oaf_production_mysql_password }}"
    priv: 'oaf-production.*:ALL'
    host: "%"

# Install php5 on xenial requires a few more jumps than usual
- name: Add repo for installing php5
  apt_repository:
    repo: 'ppa:ondrej/php'

# We're using php 5.6 as that's the latest php supported by the
# version of civicrm currently running in production
# TODO: Check latest packages required by civicrm
# TODO: Check those required by wordpress
- name: Install required packages
  apt: name={{ item }} state=present
  with_items:
    - php5.6-mysql
    - php5.6-curl
    - apache2
    - libapache2-mod-php5.6
    - mysql-client
    # TODO We'll need mod rewrite I think
  notify: reload apache

- name: Remove default index.html
  file:
    path: /var/www/html/index.html
    state: absent

- name: Set permissions
  file:
    path: /var/www/html
    owner: www-data
    group: www-data
    state: directory

# TODO: See if there is another more sensible way we could install this
- name: install wp-cli
  get_url:
    url: https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
    dest: "/usr/local/bin/wp-cli"
    mode: 0755

- name: download wordpress
  shell: "wp-cli --path='/var/www/html' core download"
  args:
    creates: /var/www/html/index.php
  become_user: www-data

- name: configure wordpress
  shell: "wp-cli --path='/var/www/html' core config --dbname=oaf-production --dbuser=oaf-production --dbpass={{ oaf_production_mysql_password }} --dbhost={{ mysql_host }}"
  args:
    creates: /var/www/html/wp-config.php
  become_user: www-data

# TODO: Is there a creates in this situation?
- name: install wordpress
  shell: "wp-cli --path='/var/www/html' core install --url=http://oaf.org.au.test --title='OpenAustralia Foundation' --admin_user={{ admin_user }} --admin_password={{ admin_password }} --admin_email=contact@oaf.org.au"
  become_user: www-data

# These are the plugins that were activated in production on kedumba. We're
# not bothering to install those that were installed but not activated.
- name: Install wordpress plugins
  shell: "wp-cli --path='/var/www/html' plugin install {{ item }}"
  args:
    creates: /var/www/html/wp-content/plugins/{{ item }}
  become_user: www-data
  with_items: "{{ wordpress_plugins }}"

# Enabling specific plugins rather than all of them at once using "--all"
# so that we don't accidently enable a plugin which is installed, not in the
# list, and not currently enabled.
- name: Activate wordpress plugins
  shell: "wp-cli --path='/var/www/html' plugin activate {{ item }}"
  become_user: www-data
  with_items: "{{ wordpress_plugins }}"

# This theme is required by the openaustralia foundation theme
- name: Install thematic theme
  shell: "wp-cli --path='/var/www/html' theme install thematic --version=1.0.4"
  args:
    creates: /var/www/html/wp-content/themes/thematic/
  become_user: www-data

- name: Install openaustralia foundation theme
  # Installs the latest on the master branch
  shell: "wp-cli --path='/var/www/html' theme install https://github.com/openaustralia/oaf-thematic/archive/master.zip --activate"
  args:
    creates: /var/www/html/wp-content/themes/oaf-thematic/
  become_user: www-data

# TODO: Upgrade openaustralia foundation theme every time if necessary

# TODO: Pick out current domain from database before conversion and only do if necessary
# TODO: When we support https don't always change to http

- name: Convert domains in database
  shell: "wp-cli --path=/var/www/html search-replace {{ item }}://www.openaustraliafoundation.org.au http://oaf.org.au.test"
  become_user: www-data
  with_items:
    - http
    - https

# TODO: Maybe worth looking at the wp-cli civicrm integration for installing civicrm?
# - name: download civicrm
#   get_url:
#     url: https://download.civicrm.org/civicrm-4.6.36-wordpress.zip
#     dest: /tmp/civicrm-wordpress.zip
#
# - name: Install zip to handle download
#   apt:
#     name: zip
#     state: present
#
# - name: install civicrm
#   unarchive:
#     src: /tmp/civicrm-wordpress.zip
#     dest: /var/www/html/wp-content/plugins
#     owner: www-data
#     group: www-data
#     copy: no
#
# - name: Fix up civicrm plugin directory permissions
#   file:
#     path: /var/www/html/wp-content/plugins/civicrm
#     owner: www-data
#     group: www-data
#     state: directory
#     recurse: yes
#
# - name: Create civicrm files directory
#   file:
#     path: /var/www/html/wp-content/plugins/files
#     owner: www-data
#     group: www-data
#     state: directory

- name: Apache config
  template:
    src: 000-default.conf
    dest: /etc/apache2/sites-available
  notify: reload apache

# TODO: How does civicrm know its database credentials?
# TODO: How are the oaf templates installed?
# TODO: Use new certificates method
# TODO: Add certificates in production
# TODO: Ensure that we're handling the alternative domain names
# TODO: Create data directory
